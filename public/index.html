<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>vcast management</title>
  <link rel="stylesheet" href="/styles.css" />
</head>

<body>
  <div class="nav"><strong>vcast</strong> / management</div>
  <div class="container">
    <section class="section">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-neutral-800" style="margin:0">Streams</h2>
          <p class="small">Add, remove, and control registered sources.</p>
        </div>
        <div class="badge" id="connectionStatus">offline</div>
      </div>
      <form id="addForm" class="flex gap-2 mt-3">
        <input type="url" name="url" class="flex-1" placeholder="https://..." required />
        <button type="submit">Add Source</button>
      </form>
      <div class="mt-3">
        <table class="table" id="sourceTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Platform</th>
              <th>URL</th>
              <th>Audio</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="section">
      <h2 class="text-neutral-800" style="margin:0">Layout</h2>
      <p class="small">Control grid rows and columns; viewers update live.</p>
      <div class="flex gap-3 mt-3">
        <label class="flex flex-col gap-1">
          Rows
          <input type="number" id="rowsInput" min="1" max="6" value="2" />
        </label>
        <label class="flex flex-col gap-1">
          Columns
          <input type="number" id="colsInput" min="1" max="6" value="2" />
        </label>
        <button id="saveLayout">Apply</button>
      </div>
    </section>
  </div>

  <script type="module">
    const state = { data: null };
    const statusEl = document.getElementById("connectionStatus");
    const tbody = document.querySelector("#sourceTable tbody");
    const rowsInput = document.getElementById("rowsInput");
    const colsInput = document.getElementById("colsInput");

    async function fetchState() {
      const res = await fetch("/api/state");
      if (res.ok) {
        state.data = await res.json();
        render();
      }
    }

    function setOnline(on) {
      statusEl.textContent = on ? "live" : "offline";
      statusEl.style.background = on ? "#14532d" : "#e5e5e5";
      statusEl.style.color = on ? "#f5f5f5" : "#111";
      statusEl.style.borderColor = on ? "#166534" : "#a3a3a3";
    }

    function render() {
      if (!state.data) return;
      rowsInput.value = state.data.layout.rows;
      colsInput.value = state.data.layout.columns;
      tbody.innerHTML = "";
      for (const s of state.data.sources) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${s.id}</td>
            <td>${s.platform}</td>
            <td style="max-width:260px; overflow:hidden; text-overflow:ellipsis;">${s.originalUrl}</td>
            <td>
              <div class="flex gap-2 items-center">
                <button data-action="toggle" data-id="${s.id}">${state.data.audio[s.id]?.muted ? "Unmute" : "Mute"}</button>
                <input type="range" min="0" max="1" step="0.05" data-action="volume" data-id="${s.id}" value="${state.data.audio[s.id]?.volume ?? 1}" />
              </div>
            </td>
            <td>
              <button class="button-muted" data-action="remove" data-id="${s.id}">Delete</button>
            </td>
          `;
        tbody.appendChild(tr);
      }
    }

    tbody.addEventListener("click", async (e) => {
      const target = e.target;
      if (!(target instanceof HTMLElement)) return;
      const action = target.dataset.action;
      const id = target.dataset.id;
      if (!action || !id) return;
      if (action === "remove") {
        await fetch("/api/remove", { method: "POST", body: JSON.stringify({ id }) });
      }
      if (action === "toggle") {
        const muted = !(state.data?.audio?.[id]?.muted);
        await fetch("/api/audio", { method: "POST", body: JSON.stringify({ id, muted }) });
      }
    });

    tbody.addEventListener("input", async (e) => {
      const target = e.target;
      if (!(target instanceof HTMLInputElement)) return;
      if (target.dataset.action === "volume" && target.dataset.id) {
        await fetch("/api/audio", {
          method: "POST",
          body: JSON.stringify({ id: target.dataset.id, volume: Number(target.value) }),
        });
      }
    });

    document.getElementById("addForm")?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;
      if (!(form instanceof HTMLFormElement)) return;
      const urlInput = form.elements.namedItem("url");
      if (!(urlInput instanceof HTMLInputElement)) return;
      const url = urlInput.value.trim();
      if (!url) return;
      await fetch("/api/add", { method: "POST", body: JSON.stringify({ url }) });
      urlInput.value = "";
    });

    document.getElementById("saveLayout")?.addEventListener("click", async () => {
      await fetch("/api/layout", {
        method: "POST",
        body: JSON.stringify({ rows: Number(rowsInput.value), columns: Number(colsInput.value) }),
      });
    });

    function connectWs() {
      const ws = new WebSocket(`${location.protocol === "https:" ? "wss" : "ws"}://${location.host}/ws`);
      ws.onopen = () => setOnline(true);
      ws.onclose = () => {
        setOnline(false);
        setTimeout(connectWs, 1500);
      };
      ws.onmessage = (event) => {
        try {
          const payload = JSON.parse(event.data);
          if (payload.type === "state") {
            state.data = payload.data;
            render();
          }
        } catch (err) {
          console.error(err);
        }
      };
    }

    fetchState();
    connectWs();
  </script>
</body>

</html>